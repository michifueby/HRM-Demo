name: Deploy HRM PaaS to AWS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  # ====================================================
  # BUILD PHASE (6 Parallel Jobs)
  # ====================================================
  build:
    name: Build ${{ matrix.service }}-${{ matrix.type }}
    runs-on: ubuntu-latest
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        service: [ core, metrics, activities ]
        type: [ frontend, backend ]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          path: src

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 1. SAFETY: Swap Space
      - name: Add Swap Space
        run: |
          sudo fallocate -l 4G /swapfile_gha
          sudo chmod 600 /swapfile_gha
          sudo mkswap /swapfile_gha
          sudo swapon /swapfile_gha

      # 2. MONITOR: Watch for freezes
      - name: Start Resource Monitor
        run: |
          (while true; do
            echo "--- [Monitor] Memory & CPU Usage ---"
            free -m
            uptime
            echo "------------------------------------"
            sleep 30
          done) &

      # 3. INSTALL & BUILD
      - name: Install dependencies + Build
        run: |
          cd src/src

          # 1. ENVIRONMENT: Unshackled
          # We REMOVED 'UV_THREADPOOL_SIZE=1' to allow the CPU to run fast again.
          # We REMOVED 'max-old-space-size' to let Node manage its own memory (using Swap if needed).
          export CI=true
          export NX_DAEMON=false
          export NX_TASKS_RUNNER_DYNAMIC_OUTPUT=false 
          export FORCE_COLOR=0
          export GENERATE_SOURCEMAP=false 

          # 2. INSTALL (Aggressive Fix)
          # We use 'npm install' instead of 'npm ci'.
          # Why? Your package-lock.json has broken/old versions of @swc/core (v1.5).
          # 'npm install' will update them to what Nx actually needs (v1.10+) automatically.
          echo "Installing dependencies (Force Resolve)..."
          npm install --legacy-peer-deps --no-audit --no-fund --ignore-scripts

          # 3. ENSURE BINARIES
          # We explicitly add the linux binary just to be safe.
          echo "Ensuring Linux Binaries..."
          npm install @swc/core-linux-x64-gnu --no-save --no-optional --ignore-scripts
          npm install @esbuild/linux-x64 --no-save --no-optional --ignore-scripts

          # 4. BUILD (High Timeout)
          # We set timeout to 60m. 
          # We allow parallel=1 but we removed the CPU throttle, so it should be much faster.
          
          echo "Build ${{ matrix.service }}-frontend (Timeout: 60m)..."
          timeout 60m ./node_modules/.bin/nx build ${{ matrix.service }}-frontend \
            --configuration=production \
            --parallel=1 \
            --max-workers=1 \
            --skip-nx-cache \
            --no-daemon \
            --sourceMap=false

          echo "Build ${{ matrix.service }}-backend (Timeout: 60m)..."
          timeout 60m ./node_modules/.bin/nx build ${{ matrix.service }}-backend \
            --configuration=production \
            --parallel=1 \
            --max-workers=1 \
            --skip-nx-cache \
            --no-daemon \
            --sourceMap=false

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.service }}-${{ matrix.type }}
          path: src/dist/apps/${{ matrix.service }}/${{ matrix.type }}
          retention-days: 1

  # ====================================================
  # DEPLOY PHASE
  # ====================================================
  deploy:
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      matrix:
        service: [ core, metrics, activities ]
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.ACTIONS_GITHUB_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Download Frontend Artifact
        uses: actions/download-artifact@v4
        with:
          name: build-${{ matrix.service }}-frontend
          path: dist_frontend

      - name: Download Backend Artifact
        uses: actions/download-artifact@v4
        with:
          name: build-${{ matrix.service }}-backend
          path: dist_backend

      - name: Deploy Frontend
        run: |
          aws s3 sync dist_frontend \
            s3://hrm-${{ matrix.service }}-frontend/ --delete --cache-control "public, max-age=60"
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets[format('CF_DISTRIBUTION_{0}', matrix.service)] }} \
            --paths "/*"

      - name: Deploy Backend
        run: |
          cd dist_backend
          zip -r ../backend.zip . > /dev/null
          VERSION="gha-${{ github.run_id }}-${{ github.run_attempt }}"
          aws elasticbeanstalk create-application-version \
            --application-name hrm-paas \
            --version-label "$VERSION" \
            --source-bundle S3Bucket=hrm-deployments,S3Key="${{ matrix.service }}-backend.zip" \
            --auto-create-application false || true
          aws elasticbeanstalk update-environment \
            --application-name hrm-paas \
            --environment-name hrm-${{ matrix.service }}-backend-env \
            --version-label "$VERSION"
