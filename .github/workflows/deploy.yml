name: Deploy HRM PaaS to AWS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  # ====================================================
  # BUILD PHASE (6 Parallel Jobs)
  # ====================================================
  build:
    name: Build ${{ matrix.service }}-${{ matrix.type }}
    runs-on: ubuntu-latest
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        service: [ hr-core, hr-metrics, hr-activities ]
        type: [ frontend, backend ]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          path: src

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 1. SAFETY: Swap Space
      - name: Add Swap Space
        run: |
          sudo fallocate -l 4G /swapfile_gha
          sudo chmod 600 /swapfile_gha
          sudo mkswap /swapfile_gha
          sudo swapon /swapfile_gha

      # 2. MONITOR: Watch for freezes
      - name: Start Resource Monitor
        run: |
          (while true; do
            echo "--- [Monitor] Memory & CPU Usage ---"
            free -m
            uptime
            echo "------------------------------------"
            sleep 30
          done) &

      # 3. INSTALL & BUILD
      - name: Install dependencies + Build
        run: |
          cd src/src

          # 1. ENVIRONMENT
          export CI=true
          export FORCE_COLOR=0
          export GENERATE_SOURCEMAP=false 
          # Keep high memory limit (Swap handles the rest)
          export NODE_OPTIONS="--max-old-space-size=6144"

          # 2. INSTALL
          npm ci --legacy-peer-deps --omit=optional --no-audit --no-fund --ignore-scripts

          # 3. FORCE UPGRADE (Vital to prevent the hang)
          echo "Forcing SWC & Esbuild Installation..."
          npm install --save-dev \
            @swc/core@latest \
            @swc/helpers@latest \
            esbuild@latest \
            @esbuild/linux-x64@latest \
            --ignore-scripts
            
          rm -rf node_modules/.cache .nx

          # 4. BUILD          
          echo "Build ${{ matrix.service }}-frontend..."
          timeout 25m ./node_modules/.bin/nx build ${{ matrix.service }}-frontend \
            --configuration=production \
            --parallel=1 \
            --skip-nx-cache \
            --sourceMap=false

          echo "Build ${{ matrix.service }}-backend..."
          timeout 25m ./node_modules/.bin/nx build ${{ matrix.service }}-backend \
            --configuration=production \
            --parallel=1 \
            --skip-nx-cache \
            --sourceMap=false

      - name: Debug - List Build Output
        run: |
          echo "Looking for dist folder..."
          ls -R src/src/dist || echo "Dist folder not found in src/src/dist"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.service }}-${{ matrix.type }}
          path: src/src/dist/apps/${{ matrix.service }}/${{ matrix.type }}
          if-no-files-found: error
          retention-days: 1

  # ====================================================
  # DEPLOY PHASE
  # ====================================================
  deploy:
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      matrix:
        service: [ hr-core, hr-metrics, hr-activities ]
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.ACTIONS_GITHUB_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Download Frontend Artifact
        uses: actions/download-artifact@v4
        with:
          name: build-${{ matrix.service }}-frontend
          path: dist_frontend

      - name: Download Backend Artifact
        uses: actions/download-artifact@v4
        with:
          name: build-${{ matrix.service }}-backend
          path: dist_backend

      - name: Deploy Frontend
        env:
          # 1. SECRET MAPPING 
          CLOUDFRONT_ID: ${{ 
            matrix.service == 'hr-core' && secrets.CF_DISTRIBUTION_HR_CORE || 
            matrix.service == 'hr-metrics' && secrets.CF_DISTRIBUTION_HR_METRICS || 
            matrix.service == 'hr-activities' && secrets.CF_DISTRIBUTION_HR_ACTIVITIES 
            }}
        run: |
          # 2. FIX S3 PATH 
          # We define the source path. If the 'browser' subfolder exists (Angular), we use that.
          SOURCE_PATH="dist_frontend"
          if [ -d "dist_frontend/browser" ]; then
            SOURCE_PATH="dist_frontend/browser"
          fi
          
          echo "Deploying content from $SOURCE_PATH to root of S3..."

          # We sync the CONTENTS of the browser folder to the ROOT of the bucket
          aws s3 sync $SOURCE_PATH s3://hrm-${{ matrix.service }}-frontend/ \
            --delete \
            --cache-control "public, max-age=60"

          # 3. DEBUG & INVALIDATE CLOUDFRONT
          if [ -z "$CLOUDFRONT_ID" ]; then
            echo "❌ ERROR: CloudFront Secret is empty!"
            echo "Expected one of these secrets to exist:"
            echo " - CF_DISTRIBUTION_HR_CORE"
            echo " - CF_DISTRIBUTION_HR_METRICS"
            echo " - CF_DISTRIBUTION_HR_ACTIVITIES"
            exit 1
          fi

          echo "✅ Found Distribution ID: $CLOUDFRONT_ID"
          aws cloudfront create-invalidation --distribution-id "$CLOUDFRONT_ID" --paths "/*"
          
      - name: Deploy Backend
        run: |
          # 1. PREPARE NAMES
          SERVICE_NAME="${{ matrix.service }}"
          CLEAN_NAME=${SERVICE_NAME#hr-} 
          DEPLOY_BUCKET="hrm-deployments-mf" 

          # 2. Create Procfile
          cd dist_backend
          
          # This tells AWS explicitly how to start the app
          echo "web: node main.js" > Procfile
          
          # 3. ZIP ARTIFACT
          # We zip '.' (current directory) which now includes main.js, package.json, AND Procfile
          zip -r ../${SERVICE_NAME}-backend.zip . > /dev/null
          cd ..
          
          # 4. UPLOAD TO S3
          echo "Uploading to S3..."
          aws s3 cp ${SERVICE_NAME}-backend.zip s3://$DEPLOY_BUCKET/${SERVICE_NAME}-backend.zip

          # 5. CREATE UNIQUE VERSION LABEL
          VERSION="gha-${{ github.run_id }}-${{ github.run_attempt }}-${SERVICE_NAME}"
          
          aws elasticbeanstalk create-application-version \
            --application-name hrm-paas \
            --version-label "$VERSION" \
            --source-bundle S3Bucket=$DEPLOY_BUCKET,S3Key="${SERVICE_NAME}-backend.zip" \
            --no-auto-create-application
          
          # 6. UPDATE ENVIRONMENT
          aws elasticbeanstalk update-environment \
            --application-name hrm-paas \
            --environment-name hrm-${CLEAN_NAME}-backend-env \
            --version-label "$VERSION"
