# .github/workflows/deploy.yml
name: Deploy HRM PaaS to AWS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [ core, metrics, activities ]

    steps:
      - name: Checkout code into src/
        uses: actions/checkout@v4
        with:
          path: src

      - name: Debug â€“ prove we have the file
        run: |
          echo "=== Current directory ==="
          pwd
          echo "=== Files in src/ ==="
          ls -la src/src/
          echo "=== First lines of package-lock.json ==="
          head -20 src/src/package-lock.json

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 1. KEEP THIS STEP (Critical for memory safety)
      - name: Add Swap Space
        run: |
          # Check existing swap for debugging
          sudo swapon --show
          
          # Create a NEW swap file (avoiding the system default /swapfile)
          sudo fallocate -l 4G /swapfile_gha
          sudo chmod 600 /swapfile_gha
          sudo mkswap /swapfile_gha
          sudo swapon /swapfile_gha
          
          # Verify total memory
          echo "Swap created. Memory status:"
          free -h

      # 2. UPDATED BUILD STEP (Native Binaries + Timeout)
      - name: Install dependencies + Build
        run: |
          cd src/src

          # ENVIRONMENT CONFIG
          # We REMOVE 'max-old-space-size' because we have Swap now.
          export CI=true
          export NX_DAEMON=false
          export NX_INTERACTIVE=false
          export NX_HEADLESS=true
          export NX_TASKS_RUNNER_DYNAMIC_OUTPUT=false 
          export UV_THREADPOOL_SIZE=1

          # INSTALL DEPENDENCIES
          echo "Installing dependencies..."
          npm ci --legacy-peer-deps --omit=optional --no-audit --no-fund

          # FORCE LINUX BINARIES
          # This downloads the specific binary needed for ubuntu-latest
          echo "Forcing Linux Binaries for SWC/Esbuild..."
          npm install @swc/core-linux-x64-gnu --no-save --no-optional
          npm install @esbuild/linux-x64 --no-save --no-optional

          # BUILD WITH TIMEOUT
          # If this hangs for 20m, it will kill itself and print the error
          
          echo "Build ${{ matrix.service }}-frontend (Timeout: 20m)..."
          timeout 20m ./node_modules/.bin/nx build ${{ matrix.service }}-frontend \
            --configuration=production \
            --parallel=1 \
            --max-workers=1 \
            --skip-nx-cache \
            --no-daemon \
            --verbose

          echo "Build ${{ matrix.service }}-backend (Timeout: 20m)..."
          timeout 20m ./node_modules/.bin/nx build ${{ matrix.service }}-backend \
            --configuration=production \
            --parallel=1 \
            --max-workers=1 \
            --skip-nx-cache \
            --no-daemon \
            --verbose

          echo "Build ${{ matrix.service }}-backend (Timeout: 20m)..."
          timeout 20m ./node_modules/.bin/nx build ${{ matrix.service }}-backend \
            --configuration=production \
            --parallel=1 \
            --max-workers=1 \
            --skip-nx-cache \
            --no-daemon \
            --verbose
            
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.ACTIONS_GITHUB_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Deploy Frontend
        run: |
          cd src
          aws s3 sync dist/apps/${{ matrix.service }}/frontend \
            s3://hrm-${{ matrix.service }}-frontend/ --delete --cache-control "public, max-age=60"
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets[format('CF_DISTRIBUTION_{0}', matrix.service)] }} \
            --paths "/*"

      - name: Deploy Backend
        run: |
          cd src
          cd dist/apps/${{ matrix.service }}/backend
          zip -r ../../${{ matrix.service }}-backend.zip . > /dev/null
          VERSION="gha-${{ github.run_id }}-${{ github.run_attempt }}"
          aws elasticbeanstalk create-application-version \
            --application-name hrm-paas \
            --version-label "$VERSION" \
            --source-bundle S3Bucket=hrm-deployments,S3Key="${{ matrix.service }}-backend.zip" \
            --auto-create-application false
          aws elasticbeanstalk update-environment \
            --application-name hrm-paas \
            --environment-name hrm-${{ matrix.service }}-backend-env \
            --version-label "$VERSION"
